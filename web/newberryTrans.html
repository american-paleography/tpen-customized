<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <title>Newberry Transcription</title>
        <link type="text/css" href="css/custom-theme/jQuery.css" rel="Stylesheet" />
        <link type="text/css" href="css/newberryTransSkin.css" rel="Stylesheet" />
        <script type="text/javascript" src="js/newberry.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
        <script src="https://use.fontawesome.com/4ae676603d.js"></script>
    </head>    
    <style>
        p{
            padding: 0px 10px;
        }
        .magnifyHelp{
            position: absolute;
            top: 1rem;
            right: 1rem;
            margin: 0 auto;
            background-color: rgb(255,252,227);
            padding: 0;
            color: #666;
            text-align: center;
            z-index: 3;
            display: none;
            box-shadow: 0 0 5px rgba(0,0,0,0.34);
            opacity: .85;
        }
        .magnifyHelp p {
            white-space: nowrap;
            margin: 0;
            padding: .25em;
        }
        
        .magifyHelp button{
            width: 35px;
        }
        
        .parsingHdr{
            margin-left: 20px;
        }
        optgroup{
            background-color: grey;
            color: #002a5c;
        }
        
        
        
    </style>
    <body>
        <div class="pageTurnCover">
            <div class="turnMsg">Please wait while we load the page...</div>
            <div class="turnLoader"><img src="images/loading2.gif" /></div>
        </div>
        <div class="topTrim navigation">
            <span class="trimSection"><span id="trimTitle">TITLE</span></span>
            <span class="trimSection">
                <span id="trimPage"></span>
                <!-- DO NOT add class exitPage.  It will try to fire the bulk update, which is not needed and will break the interface. -->
                <a class="" id="prevCanvas" onclick="previousFolio();" title="Previous Page">
                    <i class="fa fa-caret-left fa-2x"></i>
                </a>
                <select id="pageJump">
                    <option id="activePage" folioNum="0">Jump to Page</option>
                </select>
                <!-- DO NOT add class exitPage.  It will try to fire the bulk update, which is not needed and will break the interface. -->
                <a class="" id="nextCanvas" title="Next Page" onclick="nextFolio();">
                    <i class="fa fa-caret-right fa-2x"></i>
                </a>
            </span>
            <span class="trimSection" id="currentUser">
                <span id="trimCurrentUser"></span></span>
<!--            <span class="trimSection">Help</span> -->
            <div class="trimDividor" style="position:absolute;right:0;top:0;z-index: 1;">
                <span class="trimSection">
                    <span class="fa fa-home"></span><a id="homeBtn" title="Paleography Home" href="https://paleography.library.utoronto.ca/" ></a>
                </span>
                <span class="trimSection">
                    <a id="projectsBtn" class="exitPage wBtn ui-state-default ui-button" target="_blank" title="My Paleography Projects" href="https://paleography.library.utoronto.ca/my-transcriptions"></a>
                    <span class="fa fa-book"></span>       
                </span>
                <span class="trimSection"><a id="helpContact" title="Contact the French Paleography team" href="https://paleography.library.utoronto.ca/contact" target="_blank"></a><span class="fa fa-comment"></span></span> 
                <span class="trimSection"><a id="helpMe" title="Get Help" href="https://paleography.library.utoronto.ca/contact" target="_blank"></a><i class="fa fa-question" aria-hidden="true"></i></span>
            </div>
        </div>

        <div class="instructions">
            <p>
                The area below accepts a local project ID number, a project or IIIF manifest url, or a valid T-PEN or IIIF manifest JSON object as valid input.  It will then load a manifest
                to the interface for you to interact with the transcription tool.  You can click 'correct parsing' to edit the line parsings.  
                You can click the forward and backwards button in the transcription
                workspace to move through the lines on the current page or the pages in the manifest.  You can use the same arrows at the very top next to the 
                'jump to page' module to do this as well.  You can also select the specific page you want to jump to.  
                The split page tools allow you to place something next to your transcription interface.  You can view other pages in the manifest or tools from outside sources
                (like dictionaries or an abbreviation list).  Try them out.  If you get stuck or want to load a new manifest, refresh the page.  
            </p>
            <p>
                Once you have decided what to put into the area, click 'Load Transcription' to have the input created into the transcription interface.  
            </p>
        </div>
        
        <div id="setTranscriptionObjectArea">
            <textarea id="transcriptionText" placeholder="Enter a line transcription"></textarea>
        </div>
        
        <button id="loadBtn" class="hideme" onclick="loadTranscription();"> Load Transcription </button> 
        <div id="transTemplateLoading">
            <p>Please wait while we load the transcription interface.  This may take up to 2 minutes.</p>
            <div class="turnLoader transLoader"><img src="images/loading2.gif" /></div>
        </div>
        <div class="centerInterface">
        <div id="transcriptionTemplate">
            <div class="magnifyHelp">
                <p>Return to Transcribing: <kbd>ESC</kbd> or double-click</p>
                <p>
                    <span id="zoomat"></span>
                    Zoom in: <kbd>+</kbd> Zoom out: <kbd>-</kbd> </p>
            </div>
            <div id="templateResizeBar"></div>
            <div id="parsingCover"></div>
            <div id="transcriptionCanvas">
                <div id="noLineWarning">
                    <div id="noLineConfirmation">This canvas has no lines. You must be a leader for this project to create lines.
                    <span style="color: red;" onclick="$('#noLineWarning').hide()">dismiss this message</span>.</div>
                </div>
                <div id="imgTop">
                  <img class="transcriptionImage"/>
                  <div class="lineColIndicatorArea">
                  </div>
                </div>
                <div id="transWorkspace">
                    <div title="Slide Workspace" class="workspaceHandle slideHandleLeft"><i class="fa fa-bars"></i><i class="fa fa-arrows-v"></i></div><div title="Slide Workspace" class="workspaceHandle slideHandleRight"><i class="fa fa-arrows-v"></i><i class="fa fa-bars"></i></div>
                    <div class="flex-container flex-stretch">
                        <div class="flex-bookend">
                        </div>
                        <div class="flex-wide" style="position:relative;height:1em;">
<!--                            <div id="contribution"></div>
                            <div id="saveReport"></div>-->
                        </div>
                        <div class="flex-bookend">
                        </div>
                    </div>
                    <div class="flex-container flex-stretch">
                        <div class="flex-bookend">
                        </div>
                        <div id="captions" class="flex-wide">
                            <div title="Previous Line" id="prevColLine"></div>
                            <div id="captionsText"></div>
                            <span id="notes" class="quiet">&nbsp;</span>
                        </div>
                        <div class="flex-bookend">
                        </div>
                    </div>
                    <div class="flex-container flex-stretch">
                        <div class="flex-bookend">
                            <div id="pageLabel">Page</div>
                            <button id="prevPage" title="Previous Page" onclick="previousFolio();">
<!--                                <i class="fa fa-caret-left fa-2x"></i>-->
                                Prev
                            </button>
                            <button id="nextPage" title="Next Page" onclick="nextFolio();">
<!--                                <i class="fa fa-forward fa-2x"></i>-->
                                Next
                            </button>
                        </div>
                        <div id="transcriptletArea" class="flex-wide">
                            <div title="Current Line" id="currentColLine"></div>
                            <div class="xmlClosingTags"></div>
                        </div>

                        <div class="flex-bookend">
                            <div id="lineLabel">Line <span class="lineHotkeys">(alt + &UpArrow; or &DownArrow;)</span></div>
                            <button id="prevLine" title="Previous Line" onclick="previousTranscriptlet();">
<!--                                <i class="fa fa-chevron-left"></i> -->
                                Prev
                            </button>
                            <button id="nextLine" title="Next Line" onclick="nextTranscriptlet();">
                                Next 
                                <!--<i class="fa fa-chevron-right"></i>-->
                            </button>
                            
<!--                            <button id="toggleNotes" class="pull-left clear-left" role="button" onclick="$('.notes').fadeToggle('slow')" title="Toggle Notes">
                                Notes <i class="fa fa-comment"></i>
                            </button>-->
                        </div>
                    </div>
                    <div class="flex-container flex-stretch buttons let">
                        <select id="splitScreenTools" > 
                             <option id="activeSplitTool" disabled>Tools and Info</option> 
                             <optgroup label="Paleography Information">
                                <option splitter='start' class="splitTool" >Get Started</option>
                                <option splitter='dictionary' class="splitTool" >Dictionaries</option>
                                <option splitter='glossary' class="splitTool" >Glossary</option>
                                <option splitter='abbrev' class="splitTool" >Abbreviations</option>
                                <option splitter='calligraphy' class="splitTool" >Calligraphy Books</option>
                                <option splitter='conservation' class="splitTool" >Manuscript Preservation</option>
                                <option splitter='teachers' class="splitTool" >Teaching</option>
                                <option splitter='group' class="splitTool" >Group Work</option>
                                <option splitter='conventions' class="splitTool" >Transcribing & Editing Conventions</option>
                             </optgroup>
                             <optgroup label="French Paleography Resources">
                                <option splitter='essay' class="splitTool" >Background Essay</option>
                                <option splitter='partialTrans' class="splitTool" >Partial Transcriptions</option>
                                <option splitter='scripts' class="splitTool" >French Scripts and Hands</option>
                                <option splitter='frenchdocs' class="splitTool" >About French Documents</option>
                                <option splitter='fInstitutions' class="splitTool" >French Institutions</option>
                                <option splitter='maps' class="splitTool" >Historical Maps</option>
                             </optgroup>
                             <optgroup label="Other Tools">
                                <option splitter='preview' class="splitTool" >Text Preview</option>
                                <option splitter='fullPage' class="splitTool"  >View Full Page</option>
                                <option splitter='compare' class="splitTool" >Compare Page</option>
                             </optgroup>
                         </select>  
                        <button id="canvasControls" title="Page Tools">
                            Page Tools
                            <i class="fa fa-file-image-o"></i>
                        </button>
<!--                        <button style="display:inline-block;" id="ltrSwitch" title="Change Interface">
                            LTR
                            <i class="fa fa-beer"></i>
                        </button>
                        <button style="display:inline-block;" id="rtlSwitch" title="Change Interface">
                            RTL
                            <i class="fa fa-file-image-o"></i>
                        </button>-->
                        <button id="zoomLock" class="let" onclick="toggleLocking();" title="Peek Zoom Lock Setting">
                            Zoom Lock
<!--                        <i class="fa fa-picture-o" style="color: #999;background: #DDD;border-radius: 2px;"></i>-->
                        </button>
                        <button id="magnify1" class="magnifyBtn let" magnifyImg="trans" title="Inspect Transcription Image" >
                            Inspect
                            <i class="fa fa-search-plus"></i>
                        </button> <!--Page event on the listener for this class in js.-->
                        <button id="toggleChars" title="Move Transcription Image" onclick="toggleSpecialChars(event);">
                            Characters
                            <i class="fa fa-keyboard-o"></i>
                        </button>
                        <button id="toggleXML" class="let" title="Move Transcription Image" onclick="toggleXMLTags(event);">
                            XML Tags
                            <i class="fa fa-code"></i>
                        </button>
                    </div>
                    <div class="flex-container flex-stretch" style="flex-wrap: wrap; justify-content: space-around;">
                        <div id="specialCharsFloat" class="flex-container special-charactered">
                            <div id="charactersPopin" class="specialCharacters"  title="Special Characters" >
                            </div>
                            <a title="Edit Special Characters" class="lookLikeButtons editButtons exitPage" href="project.html">
                                Edit <i class="fa fa-edit"></i>
                            </a>
                        </div>
                        <div id="xmlTagFloat" class="flex-container xml-tagged">
                            <div id="xmlTagPopin" class="xmlTags" title="Custom XML Tags">
                            </div>
                            <a title="Edit XML Tags" class="lookLikeButtons editButtons exitPage" href="project.html?">
                                Edit <i class="fa fa-edit"></i>
                            </a>
                        </div>
                    </div>
                </div>
<!--                <div id="transWorkspace_old">
                    <div title="Slide Workspace" class="workspaceHandle slideHandleLeft"><i class="handl"></i></div><div title="Slide Workspace" class="workspaceHandle slideHandleRight"><i class="handl"></i></div>
                    <div id="captions"><div id="captionsText"></div></div>
                    <div id="pageControls">
                        <div id="pageLabel">Page</div>
                        <button id="prevCanvas" onclick="previousFolio();" title="Previous Page">prev</button><button id="nextCanvas" title="Next Page" onclick="nextFolio();">next</button>
                    </div>
                    <div id="transcriptletArea"></div>
                    <div id="lineCol"><div title="Previous Line" id="prevColLine"></div><div title="Current Line" id="currentColLine"></div></div>
                    <div id="lineControls">
                        <div id="lineLabel">Line</div>
                        <button id="prevLine" title="Previous Line" onclick="previousTranscriptlet();">prev</button><button id="nextLine" title="Next Line" onclick="nextTranscriptlet();">next</button>
                    </div><br>
                    <div class="bottomButtons">
                        <select id="charactersPopin" class="specialCharacters"  title="Special Characters" >
                            <option id="activeCharacters" >Characters</option> 
                        </select>
                        <select id="xmlTagPopin" class="xmlTags" title="Custom XML Tags">
                            <option id="activeTags">XML Tags</option> 
                        </select>
                        <select id="splitScreenTools" > 
                             <option id="activeSplitTool" >Split Page Tools</option> 
                             <option splitter='start' class="splitTool" >Get Started</option>
                             <option splitter='essay' class="splitTool" >Background Essay</option>
                             <option splitter='partialTrans' class="splitTool" >Partial Transcriptions</option>
                             <option splitter='groupwork' class="splitTool" >Group Work</option>
                             <option splitter='calligraphy' class="splitTool" >Calligraphy Books</option>
                             <option splitter='scripts' class="splitTool" >French Scripts and Hands</option>
                             <option splitter='frenchdocs' class="splitTool" >About French Documents</option>
                             <option splitter='conservation' class="splitTool" >Manuscript Preservation</option>
                             <option splitter='conventions' class="splitTool" >Transcribing & Editing Conventions</option>
                             <option splitter='teachers' class="splitTool" >Teaching</option>
                             <option splitter='dictionary' class="splitTool" >Dictionaries</option>
                             <option splitter='glossary' class="splitTool" >Glossary</option>
                             <option splitter='fInstitutions' class="splitTool" >French Institutions</option>
                             <option splitter='other' class="splitTool" >Other Reference Resources</option>
                             <option splitter='abbrev' class="splitTool" >Abbreviations</option>
                             <option splitter='maps' class="splitTool" >Historical Maps</option>
                             <option splitter='preview' class="splitTool" >Text Preview</option>
                             <option splitter='fullPage' class="splitTool"  >View Full Page</option>
                             <option splitter='compare' class="splitTool" >Compare Page</option>
                         </select>  
                    </div>
                    <div class="bottomButtons" style="width: 201px; top:-4px;">
                        <div id="imageTools" style="width: 201px;">
                            <div id="activeImageTool" onclick="toggleImgTools();" ><span>Image Tools</span> <i>&#9660;</i></div>   
                               <div class="toolWrap">
                                    <button style="margin-right: 18px; margin-top: 15px;" class="imgTool" which="grayscale" onclick="toggleFilter('grayscale');">Grayscale</button>
                                    <button style="margin-bottom: 10px;" class="imgTool" which="invert" onclick="toggleFilter('invert');">Invert</button>
                                    <div id="imageToolSliders" class="imgTool">
                                        Brightness
                                        <div id="brightnessSlider"></div>
                                        Contrast
                                        <div id="contrastSlider"></div>
                                    </div>
                               </div>
                        </div>
                    </div>
                    <div class="bottomButtons">
                         <button class="magnifyBtn" magnifyImg="trans" title="Magnify Transcription Image" >Magnify</button> Page event on the listener for this class in js.
                         <button id="moveImage" title="Move Transcription Image" onclick="startMoveImg();">Move Img</button>
                         <button id="parsingBtn" title="Correct Page Parsing" >Correct Parsing</button> Page event on the listener for this class in js. 
                         <button id="linebreakBtn">Linebreak</button>
                        <div  id="lineColControls">
                            <div title="Control Drawn Line Settings" id="lineCtrlLabel">Line Control</div>
                            <span style="top:14px;" title="Toggle Entire Lines" class="linehdr">Lines</span><input style="top:14px;" title="Toggle Lines" type="checkbox" onchange="toggleLineMarkers();" checked="checked"><br>
                            <span style="top:10px;" title="Toggle Lines' Indicator" class="linehdr">Line #s</span><input style="top:10px;" type="checkbox" onchange="toggleLineCol();" checked="checked">
                            <button id="markerColors" onclick="markerColors();">Line Color</button>
                        </div>
                    </div>

              </div>-->
              <div id="imgBottom">
                <img class="transcriptionImage" />
                <div class="lineColIndicatorArea"></div>
              </div><br>
            </div>
        </div>
        
         <div id="parsingSplit" class="split" >
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <div class="toolLinks">
                <!-- tool buttons for parsing -->
                </div>
                
                <div id="parsingDiv" class="">
                    <div style="margin-top: 35px;">Any lines or columns that are created or edited are saved automatically.  This is also true for edits made in the full page transcription interface.</div>
                    <div id="parseOptions">
                        <h3 class="parsingHdr">Line Parsing</h3>
                        <div id="ctrlColumnsInst" class="actions">
                            <h4 id="ctrlColumns" title="Make adjustments at the column level" class="clear-left">Column Controls</h4>
                                <div class="parsingToolButtons">
                                    <span id="createColumn" class="tpenButton" title="Create new columns by clicking and dragging" show="createColumnInst">Create Columns</span>
                                    <span id="adjustColumn" class="tpenButton" title="Adjust created column and clicking and dragging a side" show="adjustColumnInst">Adjust Columns</span>
                                    <span id="destroyColumn" class="tpenButton" title="Remove an entire column and its data with a click" show="destroyColumnInst">Destroy Columns</span>
                                    <span id="clearColumns" class="tpenButton" title="Clear the page, removing all transcription information" show="clearColumnsInst">Clear Page</span>
                                </div>
                                <div class="activeParsingTool">
                                    <div class="startHide" id="createColumnInst">
                                        <dl>
                                            <dt>New Column:</dt>
                                            <dd>Click and drag to place</dd><br>
                                        </dl>
                                    </div>
                                    <div class="startHide" id="adjustColumnInst">
                                        <dl>
                                            <dt>Adjustments:</dt>
                                            <dd>Drag the edges of an existing column</dd>
                                        </dl>
                                    </div>
                                    <div class="startHide" id="destroyColumnInst">
                                        <p class="">Click a column to remove all lines and transcription data it contains from the project.</p>
                                        <span class="ui-state-error-text"><span class="inline ui-icon ui-icon-alert"></span>This is a destructive process and cannot be undone.</span></p>
                                    </div>
                                    <div class="startHide" id="clearColumnsInst">
                                        <p class="">Click to clear the page, removing all transcription information.</p>
                                        <span class="destroyPage" class="tpenButton ui-state-error" title="Destroy all columns on this page"><span class="left ui-icon ui-icon-circle-close"></span>Destroy All Data</span>
                                        <p class="small"><span class="ui-state-error-text"><span class="inline ui-icon ui-icon-alert"></span>This is a destructive process and cannot be undone.</span><br />
                                         </p>
                                    </div>
                                </div>
                        </div>
                        <div id="ctrlLinesInst" class="actions">
                            <h4 id="ctrlLines" title="Make adjustments at the line level" class="clear-left">Line Controls</h4>
                                <div class="parsingToolButtons">
                                    <span id="addLines" class="tpenButton" title="Split lines to create new ones in a column" show="addLinesInst">Add Lines</span>
                                    <span id="mergeLines" class="tpenButton" title="Merge two lines or remove the last line from a column" show="mergeLinesInst">Merge Lines</span>
                                    <span id="adjustLines" class="tpenButton" title="Simple adjustments to individual lines" show="adjustLinesInst">Adjust Lines</span>                      
                                    <span id="removeLines" class="tpenButton" title="Delete the last line of a column" show="removeLinesInst">Remove Last Line</span>                      
                                </div>
                                <div class="activeParsingTool">
                                    <div class="startHide" id="addLinesInst">
                                        <p class="">Click within the shaded area to define the bottom of the new line.</p>
                                        <p class="small"><span class="inline ui-icon ui-icon-check"></span>This method retains all your <acronym title="Text, markup, and notes saved for lines within this column will remain attached.">transcription information</acronym>.<br />
                                        <span><span class="inline ui-icon ui-icon-info"></span>Any <acronym title="text, markup, and notes">transcription information</acronym> will remain with the line above where you click.</span><br />
                                        <span><span class="inline ui-icon ui-icon-info"></span>To add a line outside of the defined columns, <span class="ui-button loud" onclick="$('#ctrlColumns').click();$('#createColumn').click();" title="Click to use the Create a Column option">Create a Column</span>.</span></p>
                                        <div align="center">
                                            <p class="clear-left">Trouble seeing the ruler? Change the color below.</p>
                                            <div id="sampleRuler"></div>
                                            <label for="black"><input onclick="rulerColor('black');" CHECKED type="radio" value="black" name="rulerColor"/>Black</label>
                                            <label for="white"><input onclick='rulerColor("white");' id="white" type="radio" value="white" name="rulerColor"/>White</label>
                                            <input style="width:80px;" title="Type the name of any valid HTML color or code. If the code is invalid, a default color will be shown." type="text" id="customRuler" onkeyup="rulerColor('custom');" placeholder="transparent" value="transparent"/>
                                        </div>                  
                                    </div>
                                    <div class="startHide" id="mergeLinesInst">
                                        <p class="">Click within the shaded area to merge the highlighted lines.</p>
                                        <p class="small"><span class="inline ui-icon ui-icon-info"></span>This method combines your <acronym title="Text, markup, and notes saved for lines within this column will remain attached.">transcription information</acronym> into the new line.<br />
                                        <span class="ui-state-error-text"><span class="inline ui-icon ui-icon-alert"></span>If a line is removed, so in the information associated <acronym title="text, markup, and notes">with it</acronym>.</span> <br />
                                        <span><span class="inline ui-icon ui-icon-info"></span>To add a line, use the <span class="ui-button loud" onclick="$('#addLines').click();" title="Click to use the Add Lines option">Add Lines</span> option.</span></p>
                                    </div>
                                    <div class="startHide" id="removeLinesInst">
                                        <p class="">Click within the shaded area to delete the <b>last line</b> of a column.</p>
                                        <span class="ui-state-error-text"><span class="inline ui-icon ui-icon-alert"></span>If a line is removed, so is the information associated <acronym title="text, markup, and notes">with it</acronym>.</span> <br />
                                    </div>
                                    <div class="startHide" id="adjustLinesInst">
                                        <p class="">Click and drag the right side of the line to contain the line accurately.</p>
                                        <p class="small"><span class="inline ui-icon ui-icon-check"></span>This method retains all your <acronym title="Text, markup, and notes saved for each line will remain attached.">transcription information</acronym>.<br />
                                        <span><span class="inline ui-icon ui-icon-info"></span>Only the right boundary can be moved in this tool.</span><br />
                                        <span><span class="inline ui-icon ui-icon-info"></span>Make precise, individual changes in the transcription view on the currently selected line.  
                                            Hold the ALT key and drag the right side of a line to resize it.  While holding the ALT key
                                        press the left and right arrows to 'bump' the line.</span></p>
                                    </div>
                                </div>
                        </div>
                    </div>
                </div>
                <div id="sidebar">
                    <div id="progress" class="ui-widget-content ui-corner-all">Select an option above</div>
                    <div id="lineResizing" class="ui-widget-content ui-corner-all">Your <span id="originalLine">original</span> pixel line is being resized by <span id="newLine">100</span>%.</div>
                </div>
            </div>
            
            <div id="startSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/get-started?response_type=embed"></iframe>
            </div>
            
            <div id="frenchdocsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/about-french-documents?response_type=embed"></iframe>
            </div>
        
            <div id="calligraphySplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/islandora/object/paleography%3Acalligraphybooks?response_type=embed"></iframe>
            </div>
        
            <div id="mapsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/islandora/object/paleography%3Ahistoricalmaps?response_type=embed"></iframe>
            </div>
        
            <div id="scriptsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/scripts?response_type=embed"></iframe>
            </div>
        
            <div id="documentsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/about-french-documents?response_type=embed"></iframe>
            </div>
        
            <div id="conservationSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>          
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/conservation?response_type=embed"></iframe>
            </div>
        
            <div id="conventionsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/transcribing-editing-conventions?response_type=embed"></iframe>
            </div>
        
            <div id="teachersSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/teachers?response_type=embed"></iframe>
            </div>
        
            <div id="groupSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/group-work?response_type=embed" </iframe>
            </div>
        
            <div id="abbrevSplit" class="split" >
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/abbreviations?response_type=embed"></iframe>
            </div>
        
            <div id="dictionarySplit" class="split iTool">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" id="frenchDictionary" data_src="https://paleography.library.utoronto.ca/content/dictionaries?response_type=embed">
                </iframe>
            </div>
        
            <div id="glossarySplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/glossary-of-terms?response_type=embed"></iframe>
            </div>
        
            <div id="fInstitutionsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/french-institutions?response_type=embed"></iframe>
            </div>
        
            <div id="otherSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="https://paleography.library.utoronto.ca/content/other-reference-resources?response_type=embed"></iframe>
            </div>
        
           <div id="linebreakSplit" class="ui-widget ui-widget-content split">
               <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <h3>Linebreak Existing Transcription (In Development)</h3>
           </div>
            <div id="compareSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <div class="toolLinks">      
                    <select id="compareJump">
                        <option folioNum="0">Compare To</option>
                    </select>
                    <button class="showMe" onclick="restoreWorkspace();">Show Workspace</button>    
                    <button class="hideMe" style="position: relative;" onclick="hideWorkspaceToSeeImage();" >Hide Workspace</button>   
                    <button class="magnifyBtn" magnifyImg="compare" >Magnify</button>
                </div>

                <img class="compareImage" folioNum="1"></img>
            </div>
            <div id="previewSplit" class="split">
                <div class="toolLinks">      
                   <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                    <button class="showMe" onclick="restoreWorkspace();">Show Workspace</button>    
                    <button class="hideMe" style="position: relative;" onclick="hideWorkspaceToSeeImage();" >Hide Workspace</button>          
                </div> 
                <div id="previewDiv">

                </div>
            </div>
            <div id="fullPageSplit" class="split">  
                <div class="toolLinks">      
                    <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                    <button class="showMe" onclick="restoreWorkspace();">Show Workspace</button>    
                    <button class="hideMe" style="position: relative;" onclick="hideWorkspaceToSeeImage();" >Hide Workspace</button>     
                    <button class="magnifyBtn" style="position: relative;" magnifyImg="full" >Magnify</button>
                </div>
                <div id="fullPageSplitCanvas"><img id="fullPageImg" src="" /></div>
                            </div>
            <div id="essaySplit" class="split iTool">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" id="contextualEssay" data_src="https://paleography.library.utoronto.ca/content/background-essays?response_type=embed">
                </iframe>
            </div>
            <div id="partialTransSplit" class="split iTool">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" id="partialTrans" data_src="https://paleography.library.utoronto.ca/content/partial_transcriptions?response_type=embed">
                </iframe>
            </div>
            <div id="helpSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <div id="helpHeaders">
                    <a href='#helpGlossary'> glossary </a>
                    <a href='#helpShortcuts'> shortcuts </a>
                    <a href='#helpTools'> tools </a>
                    <a href='#helpNavigation'> navigation </a>
                    <!--<a href='#helpDirectNavigation'> advanced </a>-->
                </div>
                <div id="helpContainer">
                    <div id="helpGlossary" class="helpSection">
                    <div class="helpSubsection">Glossary</div>
                    <p>Commonly used terms in this application include</p>
                    <dl>
                        <dt>Page</dt>
                        <dd>A single image and supporting interface. Some source images may contain partial or multiple folios.</dd>

                        <dt>Project</dt>
                        <dd>Collection of images designated for a specific group of users. Defaults to all images within a selected manuscript, but may be altered.</dd>

                        <dt>Manuscript</dt>
                        <dd>Collection of images on a repository. Often, but not necessarily exemplary of the artifact document.</dd>

                        <dt>Group</dt>
                        <dd>Collection of users associated with a single project. Group membership is controlled by a Group Leader.</dd>

                        <dt>User</dt>
                        <dd>Entity intended to represent the human connected to a T‑PEN account.
                            Users login with the e-mail address associated with the T‑PEN account and are displayed to others by a first initial and last name.

                        <dt>Transcription</dt>
                        <dd>Usually referring to the textual data associated with an image region. Transcription metadata include specific location,
                            date of creation, and associated image data.</dd>

                        <dt>Transcription Area</dt>
                        <dd>Refers to the white textarea region where the user enters transcription text.</dd>

                        <dt>Parsing/Column Editing</dt>
                        <dd>Describes the automatic or manual process of logically splitting a page into rectangular regions to
                            designate individual lines for transcribing. Changes to parsing are saved in the history of a transcription.</dd>

                        <dt>History</dt>
                        <dd>Previous versions of transcriptions. Changes made to textual and parsing data are recorded.</dd>

                        <dt>Special Characters</dt>
                        <dd>Custom-coded buttons that automatically enter a unicode character
                            (typically one not included on the user's keyboard) into the transcription area.

                        <dt>Buttons</dt>
                        <dd>Typically refers to XML Tag objects customized on the Button Management page.
                            May also refer to Special Character objects in the same location.
                            "Buttons" may also used in the generic sense to refer to a graphically distinct, clickable region which invokes an expected action.
                        </dd>
                        </dl>
                    </div>
                    <div id="helpShortcuts" class="helpSection">
                        <div class="helpSubsection">Keyboard Shortcuts</div>
                        <p>Support for most browsers includes the following simple shortcuts:</p>
                        <dl>

                            <dt>Insert the corresponding special character at the cursor location.</dt>
                            <dd><kbd>CTRL</kbd>+<kbd>1-9</kbd></dd>

                            <dt>Jump to the first line of the current page.</dt>
                            <dd><kbd>CTRL</kbd>+<kbd>HOME</kbd></dd>

                            <dt>Move forward through lines of transcription.</dt>
                            <dd><kbd>TAB</kbd></dd>
                            <dd><kbd>ALT</kbd>+<kbd>&dArr;</kbd></dd>

                            <dt>Move backward through lines of transcription.</dt>
                            <dd><kbd>SHIFT</kbd>+<kbd>TAB</kbd></dd>
                            <dd><kbd>ALT</kbd>+<kbd>&uArr;</kbd></dd>

                            <dt>Top of Page</dt>
                            <dd><kbd>CTRL</kbd>+<kbd>HOME</kbd></dd>
                            <dd>Quickly jump to the first line of the current page.</dd>

                            <dt>Close any open tool & return to fullscreen transcription.</dt>
                            <dd><kbd>ESC</kbd></dd>

                            <dt>Peek-Zoom</dt>
                            <dd><kbd>ALT</kbd>+<kbd>CTRL</kbd></dd>
                            <dd>Hold both to use the peek-zoom, which scales the bounded area to fill the screen.</dd>

                            <dt>While Inspecting</dt>
                            <dd>+ or -</dd>
                            <dd>Each keystroke will adjust the magnification of the tool by .4x to fine tune the image result.</dd>

                            <dt>Help</dt>
                            <dd><kbd>F1</kbd></dd>

                            <dt>Browser Fullscreen</dt>
                            <dd><kbd>F11</kbd></dd>
                            <dd>Toggle fullscreen, eliminating browser and desktop toolbars.</dd>
                        </dl>
                    </div>
                    <div id="helpTools" class="helpSection">
                        <div class="helpSubsection">custom characters and XML tags</div>
                        <dl>
                            <dt>Custom Character Entry </dt>
                            <dd>To use Custom Characters
                                <ol>
                                    <li>Expand the Characters tray <button type="button" onclick="Help.lightUp('#toggleChars')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button></li>
                                    <li>Click on the desired character to insert it on the text field.</li>
                                </ol>
                            </dd>

                            <dt>Edit the Custom Characters </dt>
                            <dd>Click the Edit button on the expanded Custom Characters drawer <button type="button" onclick="Help.lightUp('.editButtons')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button> </dd>

                            <dt>XML Tag Entry </dt>
                            <dd>XML tags can always be hand-encoded by the user as they transcribe but XML Tags can be set up for ease of insertion. </dd>

                            <dt>To use XML Tags </dt>

                            <dd>Expand the XML Tag drawer <button type="button" onclick="Help.lightUp('#toggleXML')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button> </dd>
                            <dd>Highlight the text and click the desired XML tag button in the XML Tag tray to wrap the tag around the selection.</dd>
                            <dd>Insert as you type by clicking the XML tag button, adding the opening tag at the cursor
                                and put a closing tag <span class="tags ui-corner-all right ui-state-error no-point">reminder</span>
                                in the bottom right of the transcription text entry box.
                            </dd>
                            <dd>
                                To close the tag, place the cursor at the desired end point and click the reminder. Use the "x" to dismiss unwanted reminders.
                            </dd>
                        </dl>
                        <div class="helpSubsection">viewing options <button type="button" onclick="Help.lightUp('.buttons')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button></div>
                        <dl>
                            <dt>View the page image </dt>
                            <dd>To hide the work space to see the image hold <kbd>ALT</kbd>+<kbd>CTRL</kbd>.
                                While viewing, you can drag the image around with your mouse.
                                Release the keys to restore the screen. </dd>
                            <dt>Inspect</dt>
                            <dd>To view parts of the image under magnification click the Inspect button. <button type="button" onclick="Help.lightUp('#magnify1')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>
                                Once in the inspect view you can use <kbd>+</kbd> and <kbd>-</kbd> to change the magnification.
                                Press <kbd>ESC</kbd> to return to the transcription view.</dd>
                            <dt>Peek-Zoom</dt>
                            <dd>To quickly fill the screen with the line being transcribed hold <kbd>CTRL</kbd>+<kbd>SHIFT</kbd>.
                                This will enlarge the line being transcribed to fill the viewing window above the tool bar.
                                Release the keys to restore the screen. </dd>
                        </dl>

                        <div class="helpSubsection"> split screen tools </div>

                        <dl>
                            <dt>Import Text </dt>
                            <dd>Upload a file for manual or automatic linebreaking. </dd>

                            <dt>Line History </dt>
                            <dd>Lists the previous saved versions of the line boundaries and transcription text.
                                Mouseover the history entries to reveal options to revert to a previous version.
                            </dd>

                            <dt>Preview Transcription </dt>
                            <dd>Reveal the transcription text on the previous, current, and following pages.
                                Edit text in the transcription workspace or within the tool. </dd>

                            <dt>Compare Pages </dt>
                            <dd>View other pages from this project. Use the inspection tool to take a closer look. </dd>

                            <dt>Capelli Abbreviations </dt>
                            <dd>A. Capelli's <cite>Lexicon Abbreviaturarum</cite> for Latin and Italian abbreviations. </dd>
                        </dl>

                        <div class="helpSubsection">page tools <button type="button" onclick="Help.lightUp('#canvasControls')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button> </div>
                        <dl>
                            <dt>Image Controls </dt>
                            <dd>These tools are designed to allow the user to manipulate the image to facilitate legibility.
                                All these adjustments are superficial and will not persist.</dd>

                            <dt>Grayscale </dt>
                            <dd>Presents the image as a grayscale image </dd>

                            <dt>Invert </dt>
                            <dd>Presents the image with its color inverted. </dd>

                            <dt>Brightness </dt>
                            <dd>A slider tool to raise and lower the brightness of the image.
                                <small>Note: not supported by Safari.</small> </dd>

                            <dt>Contrast </dt>
                            <dd>A slider tool to raise and lower the contrast of the image.
                                <small>Note: not supported by Safari.</small> </dd>
                        </dl>
                        <div class="helpSubsection">column controls</div>
                            <dl>
                                <dt>Zen Line </dt>
                                <dd>Remove all line information and just focus on the line you are looking at. </dd>
                                
                                <dt>Minimal Lines </dt>
                                <dd>Reduce all lines to their minimal form (only a single line will show, not the box) </dd>
                                
                                <dt>Show Lines </dt>
                                <dd>Toggle the text column lines on and off. </dd>

                                <dt>Show Labels </dt>
                                <dd>Toggle the text letter/number labels next to each line on and off. </dd>

                                <dt>Change Line Color </dt>
                                <dd>Click to change the color of the lines and labels to improve visibility. </dd>

                                <dt>Edit Columns </dt>
                                <dd>Open the column editing/parsing interface to adjust and edit the columns and lines. </dd>
                            </dl>

                    </div>
                    <div class="helpSubsection"> navigation </div>
                    <div id="helpNavigation" class="helpSection">
                        <dl>
                            <dt>Location Flag <button type="button" onclick="Help.lightUp('#trimPage')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button></dt>
                            <dd>Shows the label for the current page.</dd>
                            <dt>Jump to page <button type="button" onclick="Help.lightUp('#pageJump')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button></dt>
                            <dd>Select any page in the current project.</dd>
                            <dt>Previous Page <button type="button" onclick="Help.lightUp('#prevPage'); Help.lightUp('#prevCanvas');" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button></dt>
                            <dt>Next Page <button type="button" onclick="Help.lightUp('#nextPage'); Help.lighUp('#nextCanvas');" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button></dt>
                            <dd>Step through the project one page at a time.</dd>
                        </dl>
                    </div>
<!--                    <div id="helpDirectNavigation" class="helpSection">
                        <div class="helpSubsection"> advanced </div>
                        <dl>
                            <dt>http://t-pen.org/TPEN/manifest/{projectID}</dt>
                            <dd>Shows the SharedCanvas Manifest for this project.</dd>
                            <dt>http://t-pen.org/TPEN/project/{projectID}</dt>
                            <dd>Shows the SharedCanvas Manifest for this project.</dd>
                            <dt>http://t-pen.org/TPEN/project.jsp?projectID={projectID}</dt>
                            <dd>Go directly to project management for this project.</dd>
                            <dt>http://t-pen.org/TPEN/transcription.html?projectID={projectID}</dt>
                            <dd>Go directly to the transcription interface for this project.</dd>
                            <dt>http://t-pen.org/TPEN/groups.jsp?projectID={projectID}</dt>
                            <dd>View or Manipulate the users associated with this project.</dd>
                        </dl>
                    </div>-->
                </div> 
            </div>
            <div id='controlsSplit' class='split' style="width:200px;max-width:200px;overflow:auto;">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <div class="controlOrganizer">
                    <button style="margin-bottom: 8px;" class="block" onclick="resetImageTools(false);" title="Reset Tools">
                    Reset to Defaults
                    </button>
                    <header> Image Controls </header>

                    <button which="grayscale" class="block" onclick="toggleFilter('grayscale');" title="Grayscale">
                        Grayscale
                        <i class="fa fa-picture-o" style="color: #999;background: #DDD;border-radius: 2px;"></i>
                    </button>
                    <button which="invert" class="block" onclick="toggleFilter('invert');">
                        Invert
                        <i class="fa fa-picture-o" style="background: #FFF;border-radius: 2px;color: #000;"></i>
                    </button>
                    <div id="imageToolSliders" class="imgTool">
                        Brightness  <i class="fa fa-sun-o"></i>
                        <div id="brightnessSlider"></div>
                        Contrast  <i class="fa fa-adjust"></i>
                        <div id="contrastSlider"></div>
                    </div>
                    <header> Column Controls</header>
                    <button role="button" id="zenLine" class="block" onclick="toggleZenLine();">Zen Line</button>
                    <button role="button" id="minimalLines" class="block" onclick="toggleMinimalLines();">Minimal Lines</button>
                    <button id="showTheLines" role="button" class="block selected" onclick="toggleLineMarkers();">
                        Lines
                    </button>
                    <button id="showTheLabels" role="button" class="block selected" onclick="toggleLineCol();">
                        Labels
                    </button>
                    <button role="button" id="markerColors" class="block" onclick="markerColors();">Change Line Color</button>
                    <button role="button" id="parsingBtn" title="Redraw the lines on this page" class='block'>
                        Edit Columns
                        <i class="fa fa-barcode fa-rotate-90"></i>
                    </button>

                    <header>
                        Keyboard Shortcuts
                    </header>
                    <div style="text-align: left;">
                        <strong>View/Move Image</strong><br>
                        <kbd>CTRL</kbd>+<kbd>ALT</kbd>: hold to temporarily hide the workspace and drag around your page image
                    </div>
                    <div style="text-align:left;">
                        <strong>Peek-Zoom</strong><br>
                        <kbd>CTRL</kbd>+<kbd>SHIFT</kbd>: peek-zoom into the current line of transcription
                    </div>
                </div>
            </div>
            <div style="clear:both"></div>
        </div>
        <div id="zoomDiv" class="ui-corner-all"></div>
        <div id="ruler1"></div><div id="ruler2"></div>
        <div id="genericIssue" class="ui-widget ui-corner-all ui-widget-content">
            <h2 class="ui-widget-header ui-corner-all">Data Error</h2>
            <p>
                There was an issue saving some of your data.  Please refresh the page to resume your activity.  If you continue to see this error
                please contact the T&#8209;PEN Admin.
            </p>
            <div class="clear right buttons">
                <button class="ui-button tpenButton" onclick="document.location.reload();">OK</button>
            </div>
        </div>
        <div id="overlay" class="ui-widget-overlay">
            <div id="overlayNote">Click the page to return</div>
        </div>
        <div id="location" class="ui-widget-content ui-corner-tr">
        </div>
        <div class="trexHead"></div>
        <noscript>
            <div id="noscript">
                You are blocking scripts on this page. T-PEN uses 
                <code>googleapis.com</code> and <code>javascript</code> 
                for necessary functionality.
            </div>
            <div class="trexHead" style="display:block"></div>
        </noscript>
    </body>
</html>
<script>
    var theProjectID = -1;
    
    //Page load event triggers and attached here.
    $(window).on('load',function(){
        attachWindowResize();
        $("iframe").on('load', function (){
            $(this).removeClass("loadingIframe");
        });
        //Stop page from being out of wack after following a help header link
        $("#helpHeaders a").click(function(){
            setTimeout(function(){
                document.body.scrollTop = document.documentElement.scrollTop = 0;
            },1);
        });
        $("#imgTop, #imgBottom").css("height", "400px");
        $("#imgTop img, #imgBottom img").css("height", "400px");
        $("#imgTop img, #imgBottom img").css("width", "auto");
        //$('.transcriptionImage').attr('src', "images/loading2.gif"); //background loader if there is a hang time waiting for image
        //check if logged in
        var user = "";
        var url = "geti";
        $.ajax({
            url: url,
            type: "GET",
            dataType: "json",
            success: function(data){
//                console.log("user data");
//                console.log(data);
                if(data.uname && data.uname !== ""){
                    user = '<i class="fa fa-user"></i> '+data.uname;
                    loggedInUser = true;
                    $("#trimCurrentUser").html(user);
                    $("#trimCurrentUser").attr("title",data.uname);
                    var theURL = window.location.href;
                    if (theURL.indexOf("projectID=") > -1){
                        var projID = getURLVariable("projectID");
                        theProjectID = parseInt(projID);
                        $(".editButtons").attr("href", "project.html?projectID="+theProjectID);
                        $("#transcriptionText").val(projID);
                        $("#loadBtn").click();
                    }
                    else{
                        $('#transcriptionTemplate').hide();
                        $('#setTranscriptionObjectArea').show();
                        $(".instructions").show();
                        $(".hideme").show();
                    }
                }
                else{
                    $("#trimCurrentUser").html("No User");
                    loggedInUser = false;
                    var theURL = window.location.href;
                    var projID = theURL.substring(theURL.indexOf("projectID=")+10);
                    if (theURL.indexOf("projectID=") > -1){
                        theProjectID = parseInt(projID);
                        alert("You must be logged in to view project "+projID);
                    }
                    $('#transcriptionTemplate').hide();
                    $('#setTranscriptionObjectArea').show();
                    $(".instructions").show();
                    $(".hideme").show();
                    $("#parsingBtn").unbind("click");
                    $("#parsingBtn").attr("onclick","");
                    $("#parsingBtn").click(function(){
                        alert("You must be logged in to correct line parsing.  Log in and refresh the page to correct parsing.");
                    });
                }
                //only get iframes after confirmed user authentication
                
            },
            error: function(jqXHR,error, errorThrown) { 
                $("#trimCurrentUser").html("No User");
                loggedInUser = false;
                var theURL = window.location.href;
                var projID = theURL.substring(theURL.indexOf("projectID=")+10);
                if (theURL.indexOf("projectID=") > -1){
                    alert("You must be logged in to view project "+projID);
                }
                $('#transcriptionTemplate').hide();
                $('#setTranscriptionObjectArea').show();
                $(".instructions").show();
                $(".hideme").show();
                $("#parsingBtn").unbind("click");
                $("#parsingBtn").attr("onclick","");
                $("#parsingBtn").click(function(){
                    alert("You must be logged in to correct line parsing.  Log in and refresh the page to correct parsing.");
                });
            }
        });


        //get all project metadata so that we can get the project and user tools. 
        $(".split").find('iframe').css("height", window.innerHeight+"px");
        $('select').find('option:eq(0)').prop("selected",true); //stops certain bugs caused by previously selected dropdown options.  
        $('select').removeAttr("disabled");
        $("#pageJump").on("change",function(){
            var parsing = "";
            if($("#parsingDiv").is(":visible")){
                parsing = "parsing";
            }
            var a = $(this).find("option:selected");
            var b = a.attr("folioNum");
            pageJump(b, parsing);
        });
         $("#compareJump").on("change",function(){
            var a = $(this).find("option:selected");
            var b = a.attr("folioNum");
            compareJump(b);
        });
         $("#splitScreenTools").on("change",function(event){
            var a = $(this).find("option:selected");
            var b = a.attr("splitter");
            splitPage(event,b);     
        });

        $('#transcriptionFile').on("change", function(event){;
            var selectedFile = event.target.files[0];
            var reader = new FileReader();
            var result = $('#transcriptionText')
            reader.onload = function(event){
              var fileContent = event.target.result;
              result.html(fileContent);
              $('#transcriptionTemplate').hide();
            };
            reader.readAsText(selectedFile);
        });
        

        $(".fullScreenTrans").click(function(){
            fullPage();
        });
        
        $("#charactersPopin").on("change", function(event){
            var val = $("#charactersPopin").val();
            addchar(val, "");
        });
        
        $("#xmlTagPopin").on("change", function(event){
            var val = $("#xmlTagPopin").val();
            addchar(val, "");
        });

        $(".magnifyBtn").click(function(event){
            if ($(this).hasClass("ui-state-active")){
                $('#zoomDiv').hide();
                restoreWorkspace();
                isMagnifying = false;
                $(document).off("mousemove");
                $(this).removeClass("ui-state-active");
            } else {
                $(this).addClass("ui-state-active");
                isMagnifying=true;
                magnify($(this).attr("magnifyImg"),event);
            }
        });
        
        $("#imgTop, #imgBottom").hover(function(){
            if(!minimalLines){
                //var color = colorThisTime.replace(".4", "1");
                $('.activeLine').css('box-shadow', '0px 0px 15px 8px '+colorThisTime);
                $('.activeLine').css('opacity', '1');
            }
        }
        , function(){
            if(!minimalLines){
                var color2 = colorThisTime.replace(".4", "1");
                $('.activeLine').css('box-shadow', '0px 0px 15px 8px '+color2);
                $('.activeLine').css('opacity', '.75');
            }
        });

        document.addEventListener("mousewheel", function(e){
            if(isMagnifying){
                event.preventDefault();
                var wDelta = e.wheelDelta < 0 ? 'down' : 'up';
                if(wDelta === "up"){
                    zoomMultiplier += .4;
                    $(document).mousemove();
                }
                else{
                    zoomMultiplier -= .4;
                    $(document).mousemove();
                }
            }
        });
        
        $(document)
            .dblclick(function(){
                if(isMagnifying){
                    stopMagnify();
                }
            })
            .keydown(function(event){
                var ctrlDown = false,
                ctrlKey = 17,
                cmdKey = 91;
                if(isMagnifying){
                    //back out
                    if ((event.which === 109) || (event.which === 189) || (event.which === 173) ){ //173  = - in firefox
                        if(zoomMultiplier > .5){
                            zoomMultiplier -= .4;
                            $(document).trigger('mousemove');
                        }
                    }
                    //ease in
                    else if ((event.which === 107) || (event.which === 187) || (event.which === 61)){ // 61 = + in firefox
                        if(zoomMultiplier < 10){
                           zoomMultiplier += .4;
                           $(document).trigger('mousemove');
                        }
                    }
                    //esc
                    else if(event.which === 27){
                        stopMagnify();
                    }
                    else {

                    }
                    $("#zoomat").text(Math.round(zoomMultiplier*10)/10+"x");
                }
                else if (event.which == 112) { //F1 for help
                    event.preventDefault();
                    //DO NOT pull up the help if the user is using another tool that is taking up the screen.  It breaks the interface..  
                    if(liveTool === "none"){
                        splitPage(event, "help");
                    }
                    else if(liveTool === "help"){
                        //F1 should toggle help, not just show.  Handle that here. 
                        fullPage();
                    }
                }
                else if (event.which == 18 || event.altKey && (liveTool !=="parsing")){
                   //console.log('ALT KEY');
                   //var lineForEditing = $(".activeLine");
                   //lineForEditing.resizable();
                   if(event.altKey&&event.ctrlKey || event.altKey&&event.metaKey){
                       // hide workspace and move image
                       toggleMoveImage(event);
                   }
                   else if(event.which === 38){ //up.  Go to prev line
                       previousTranscriptlet();
                   }
                   else if(event.which === 40){ //down. Go to next line.
                       nextTranscriptlet();
                   }
                }
                else if (event.which === 27){
                    //Esc during any active tool means stop the tool.  In this case, our only worry is moving the image around.  We may add others later.
                    $("#imgTop, #imgBottom").unbind("mousemove");
                    $("#imgTop, #imgBottom").unbind("mousedown");
                    $("#imgTop, #imgBottom").unbind("mouseup");
                    //still need hover event on imgTop
                    $("#imgTop").css("cursor", "default");
                    $("#imgBottom").css("cursor", "default");
                    $(".magnifyBtn").removeClass("selected");
                    $("#moveImage").removeClass("selected");
                    $(".transcriptlet").children("textarea").removeClass("imageMove").removeAttr("disabled");
                    if(isPeeking && zoomLock){
                        //Maybe isPeeking should play into liveTool when zoomLock...
                        //There will be no oother liveTool if isPeeking and zoomLock...
                        peekZoom(true);
                    }
                    else if(liveTool == "parsing"){//this stuff needs to happen when tpen.screen.liveTool="parsing"
                        //Make sure all the parsing stuff is unselected.  The function that does this is toggleSelected(), but it doesn't work quite right here...
                        $("#ctrlColumnsInst").find(".activeParsingTool").fadeOut(800);
                        $("#ctrlLinesInst").find(".activeParsingTool").fadeOut(800);
                        $("#imgTop").children(".line").addClass("parsing").removeClass("line");
                        $(".parsing").css("z-index", "5");
                        $('.parsing').unbind();
                        $(".parsing").css('cursor','default');
                        $(".parsingColumn").remove();
                        $("#parsingSplit .tpenButton.selected").removeClass("selected active");
                        //This is from fullPage() since it is conditional whether or not you fire it.
                        $(document).unbind("mousemove");
                        $(document).unbind("mousedown");
                        $(document).unbind("mouseup");
                    } 
                    else if(liveTool && liveTool !== "none"){ 
                        //Cancel any live tool and go full page mode
                         fullPage();
                    }

                }
                else if (event.which === 13 && (liveTool !=="parsing")){ //enter
                    if (event.shiftKey || event.altKey) return true;
                    event.preventDefault();
                    //Linebreak.moveTextToNextBox();
                    return nextTranscriptlet();
                }
                else if (event.which === 9 && (liveTool !=="parsing")){ // tab
                //TAB hijack to keep behavior as expected
                    var inForm = $(document.activeElement).is('input,textarea') && !$(document.activeElement).parent().is('.transcriptlet');
                    if(event.which === 9 && !inForm){
                        event.preventDefault();
                        event.stopPropagation();
                        if(event.shiftKey) $("#prevLine").click();
                        else $("#nextLine").click();
                    }
                }
                else if (event.ctrlKey || event.metaKey && (liveTool !=="parsing")) { //ctrl
                    //This is also how you select a new tab in the browser.
                    if(event.which >= 49 && event.which <= 57){ //insert a special char
                        event.preventDefault();
                        event.stopPropagation();
                        //find the index in the special chars field and insert it.
                        var hotkey = $("#charactersPopin").children().eq(String.fromCharCode(event.which)-1);
                        hotkey.click(); //populating to the text field fires in onclick to this element, we have to register the change.
                    }
                    else if(event.ctrlKey && event.which === 36){ //HOME key.  Jump to first line.
                        event.preventDefault();
                        event.stopPropagation();
                        if($("div[pair='A1']").length){
                            $("div[pair='A1']").click();
                        }
                    } 
                    else if (event.shiftKey && !isPeeking && !isMagnifying) {
                        // Peek-Zoom
                        peekZoom(false);
                    }
                }
                else {

                }
            })
            .keyup(function(event){
                if(isMagnifying){
                    return event;
                }
                if(event.which == 18){
                    $("#imgTop, #imgBottom").css("cursor", "default");
                    $("#imgTop, #imgBottom").unbind("mousemove");
                    $("#imgTop, #imgBottom").unbind("mousedown");
                    $("#imgTop, #imgBottom").unbind("mouseup");
                }
                else if(isPeeking && (!event.shiftKey || !(event.ctrlKey||event.metaKey)) && !zoomLock){
                    // cancel Peek-Zoom, only if user does not have zoom lock setting active.
                    peekZoom(true);
                }
                else if(toggleMove && (!event.altKey || !event.ctrlKey || !event.metaKey)){
                    //cancel show and/or move image.  Must do this here because it is possible the user never moves the image and moveImg() won't handle the cancel case.
                    //Do not check against tpen.screen.isMoving, just make sure we are not peeking (they share the ctrlKey or metaKey, so they both tend to want to fire).
                    toggleMoveImage(false);
                }
            });

//        $(document).keydown(function(event){
//            if(isMagnifying){
//                //back out
//                if ((event.which === 109) || (event.which === 189) || (event.which === 173) ){ //173  = - in firefox
//                    zoomMultiplier -= .4;
//                    $(document).mousemove();
//                }
//                //ease in
//                else if ((event.which === 107) || (event.which === 187) || (event.which === 61)){ // 61 = + in firefox
//                    zoomMultiplier += .4;
//                    $(document).mousemove();
//                }
//                //esc
//                else if(event.which === 27){
//                    stopMagnify();
//                }
//                else {
//
//                }
//            }
//            else if (event.which == 18 || event.altKey){
//              // console.log('ALT KEY');
//               var lineForEditing = $(".activeLine");
//               lineForEditing.resizable();
//               //alt + arrows will bump active line left and right
//               if(event.which == 37 && (event.altKey||event.which == 18)){
//                   //left
//                   event.preventDefault();
//                   bumpLine("left", lineForEditing);
//                   
//               }
//               else if (event.which == 39 && (event.altKey||event.which == 18)){
//                   //right
//                   event.preventDefault();
//                   bumpLine("right", lineForEditing);
//               }
//            }
//            else if (event.which === 27){
//                //Esc during any active tool means stop the tool.  In this case, our only worry is moving the image around.  We may add others later.
//                $("#imgTop, #imgBottom").unbind("mousemove");
//                $("#imgTop, #imgBottom").unbind("mousedown");
//                $("#imgTop, #imgBottom").unbind("mouseup");
//                //still need hover event on imgTop
//                $("#imgTop").css("cursor", "default");
//                $("#imgBottom").css("cursor", "default");
//                $(".magnifyBtn").removeClass("selected");
//                $("#moveImage").removeClass("selected");
//                $(".transcriptlet").children("textarea").removeClass("imageMove").removeAttr("disabled");
//                
//                
//                if(liveTool && liveTool !== "none" && liveTool !== "parsing"){
//                    fullPage();
//                }
//                else{ //this stuff needs to happen when tpen.screen.liveTool="parsing"
//                    //Make sure all the parsing stuff is unselected.  The function that does this is toggleSelected(), but it doesn't work quite right here...
//                    $("#addLines").click() //resets the lines UI to their default state
//                    $(".splitBlock.selected").children(".tpenButton.selected").removeClass("selected");
//                    $(".splitBlock.selected").children(".tpenButton.selected").removeClass("active"); //not 100% sure we need this
//                    $(".splitBlock.selected").removeClass("selected");
//                    $(".icon-panel").find(".selected").removeClass("selected");
//                    //This is from fullPage() since it is conditional whether or not you fire it.
//                    $(document).unbind("mousemove");
//                    $(document).unbind("mousedown");
//                    $(document).unbind("mouseup");
//                    $(".parsing").unbind();
//                }
//                
//            }
////            else if (event.which === 27){
////                //Esc during any active tool means stop the tool.  In this case, our only worry is moving the image around.  We may add others later. 
////                ////console.log("ESC DOWN");
////                $("#imgTop, #imgBottom").unbind("mousemove");
////                $("#imgTop, #imgBottom").unbind("mousedown");
////                $("#imgTop, #imgBottom").unbind("mouseup");
////                //still need hover event on imgTop
////                $("#imgTop").css("cursor", "default");
////                $("#imgBottom").css("cursor", "default");
////                $(".magnifyBtn").removeClass("selected");
////                $("#moveImage").removeClass("selected");
////                $(".transcriptlet").children("textarea").removeClass("imageMove").removeAttr("disabled");
////            }
//            else if (event.which === 13){ //entr
//                var activeTranscriptlet = $(".transcriptlet:visible");
//                if(activeTranscriptlet.find('textarea').is(":focus")){
//                    nextTranscriptlet();
//                }
//            }
//             else if (event.which == 112) { //F1 for help
//                event.preventDefault();
//                //DO NOT pull up the help if the user is using another tool that is taking up the screen.  It breaks the interface..  
//                if(liveTool === "none"){
//                    splitPage(event, "help");
//                }
//                //$("#helpMe").click();
//            }
//            else{
//                ////console.log(event.which+" DOWN");
//            }
//            })
//            .keyup(function(event){
//                if(event.which == 18 || event.altKey){
//                    $("#imgTop,#imgBottom").unbind("mousemove").css("cursor", "default");
//                    $("#imgTop, #imgBottom").unbind("mousedown");
//                    $("#imgTop, #imgBottom").unbind("mouseup");
//                    //restoreTransition();
//                    //unShiftInterface();
//                }
//                else{
//                   // //console.log(event.which+' UP');
//                }
//            });
            
            $("#parsingBtn").click(function(){
                if(isFullscreen)isUnadjusted = true;
                isFullscreen = false;
                hideWorkspaceForParsing();
                $("#confirmParsingInst").show();
                $("#parsingBtn").css("box-shadow", "");
            });
            $("#canvasControls").click(function(event){
               splitPage(event, "controls");
            });
            
            $(".workspaceHandle").mousedown(function(event){moveWorkspace(event);})
            .css("cursor","n-resize");
    
            $(".parsingToolButtons").children("span").click(function(event){
                var show = $(this).attr("show");
                $("#imgTop").unbind("mousemove");
                $("#imgTop").unbind("mousedown");
                $("#imgTop").unbind("mouseup");
                $("#imgTop").css("cursor", "default");
                $("#imgBottom").css("cursor", "default");
                $(".parsing").removeClass("adjustable");
                $(".parsing").unbind('mousemove');
                $("#ruler1").hide();
                $("#ruler2").hide();
                $(".parsingColumn").off();
                $(".parsingColumn").unbind();
                var thisID = $(this).attr("id");
                $(".parsingToolButtons").find(".tpenButton").removeClass("selected");
                $(this).addClass("selected");
                if (thisID == "createColumn" || thisID == "destroyColumn" || thisID=="clearColumns" || thisID=="adjustColumn") {
                    $("#addLines").removeClass("active");
                    $("#removeLines").removeClass("active");
                    $("#ctrlColumnsInst").find(".startHide").hide();
                    $("#"+show).fadeIn(800);
                    $("#ctrlColumnsInst").find(".activeParsingTool").fadeIn(800);
                    $("#ctrlLinesInst").find(".activeParsingTool").fadeOut(800);
                    $(".parsing").unbind();
                    $(document).unbind("mousedown");
                    $(document).unbind("mousemove");
                    $(document).unbind("mouseup");
                    linesToColumns();
                    if(thisID == "adjustColumn"){
                        adjustColumn(event);
                    }
                    else if (thisID == "createColumn"){
                        $.each($(".parsingColumn"), function(){
                            $(this).removeClass("parsingColumnSelected");
                        });

                        var isCreating = true;
                        //adjustColumn(event);
                        //console.log("New or reparse column");
                        var offset = $('#imgTop').offset();
                        var point = {};
                        var deltaPoint = {x:0,y:0};
                        
                        $(document).bind({
                                mousedown: function(event){
                                    //This bit of mouse down ensures it only fires on left mouse click.
                                    event = event || window.event;
                                    if(event.pageY <= offset.top || event.pageX <= offset.left || event.pageX >= (offset.left + $("#imgTop").width())){ //If you try to draw off of imgTop....
                                        return false;
                                    }
                                    if ("buttons" in event) {
                                        if(!event.buttons === 1){
                                            return false;
                                        }
                                    }
                                    else{
                                        var check = event.which || event.button;
                                        if(check!==1){
                                            return false;
                                        }
                                    }
// Why this? It stops it from working when overlapping an existing column 3-9-17                                    
//                                    if ((event.target.className.indexOf("transcriptionImage") === -1 )){
//                                        isCreating = false;
//                                        return true;
//                                    }
                                    //else{
                                    event.preventDefault();
                                    var newCol = "<div id='newCol' class='newColumn parsingColumn ui-resizable' style='z-index:1000;'></div>";
                                    point = {x:event.pageX - offset.left,y:event.pageY - offset.top};
                                    $(newCol).insertBefore($("#imgTop img")).css({
                                        'position'  : 'absolute',
                                        'top': point.y,
                                        'left': point.x,
                                        'min-width' : "5px",
                                        'min-height': "5px"
                                    });
                                    //}

                                },
                                mousemove:  function(event){
                                    event.preventDefault();
                                    deltaPoint = {
                                        x: event.pageX-offset.left-point.x,
                                        y: event.pageY-(point.y)
                                    };
                                    if (deltaPoint.x < 0) {
                                      // right to left drawing
                                      $("#newCol").css("left", point.x + deltaPoint.x);
                                    }
                                    if (deltaPoint.y < 0) {
                                      // bottom to top drawing
                                      $("#newCol").css("top", point.y  + deltaPoint.y);
                                    }
                                    $("#newCol").css({
                                      "width": Math.abs(deltaPoint.x),
                                      "height": Math.abs(deltaPoint.y) - 32 //header (.topTrim)
                                    });
                                },
                                mouseup:    function(event){
                                    event.preventDefault();
                                    var $newCol = $("#newCol");
                                    if(event.pageY <= offset.top || event.pageX <= offset.left || event.pageX >= (offset.left + $("#imgTop").width())){ //If you try to draw off of imgTop....
                                        $newCol.remove();
                                        return false;
                                    }
                                    $("#parsingCover").show();
                                    if (!isCreating){
                                        $(document).unbind("mousemove");
                                        $(document).unbind("mousedown");
                                        $(document).unbind("mouseup");
                                        $("#imgTop").css("cursor", "default");
                                        $("#imgBottom").css("cursor", "default");
                                        return true;
                                    }
                                    
                                    $newCol.attr({
                                        "newline"       : true,
                                        "newcol"        : true,
//                                        "linetop"       : parseFloat($newCol.css("top")) / $("#imgTop").height() * 100,
//                                        "lineleft"      : parseFloat($newCol.css("left")) / $("#imgTop").width() * 100,
//                                        "linewidth"     : $newCol.width() / $("#imgTop").width() * 100,
//                                        "lineheight"    : $newCol.height() / $("#imgTop").height() * 100,
                                        "startid"        : "",
                                        "endid"          : "",
                                        "hastranscription": false,
                                        id: ""
                                    });
                                    $newCol.css("background-color","transparent");
                                    // Prevent tiny columns on accident
                                    if (parseInt($newCol.width())+parseInt($newCol.height()) < 12) {
                                        $newCol.remove();
                                        console.log("Hiding cover because of tiny column no save scenario");
                                        $("#parsingCover").hide();
                                        return true;
                                    }
                                    isAddingLines = true;
                                    var newY = parseFloat($newCol.css("top")) / $("#imgTop").height() * 100;
                                    var newX = parseFloat($newCol.css("left")) / $("#imgTop").width() * 100;
                                    var newH = $newCol.height() / $("#imgTop").height()* 100;
                                    var newW = $newCol.width() / $("#imgTop").width() * 100;

                                    //The column is now a line, so put that into the UI and save it to the DB.
                                    var columnIsLine =$(
                                    "<div class='parsing newColumn' style='\n\
                                        top:"+newY+"%; \n\
                                        left:"+newX+"%; \n\
                                        height:"+newH+"%; \n\
                                        width:"+newW+"%; \n\
                                        z-index : -10;\n\
                                        ' lineserverid=''\n\
                                        linetop='"+newY+"'\n\
                                        lineleft='"+newX+"'\n\
                                        lineheight='"+newH+"'\n\
                                        linewidth='"+newW+"'>\n\
                                    </div>");
                                    if(isCreating){
                                        saveNewLine(null,columnIsLine);
                                        //TODO FIXME here, we need to set lineserverid
                                        $("#imgTop").append(columnIsLine);
                                    }
                                    //adjustColumn(); //Do this so that the new column is adjustable.
                                    $("#createColumn").ajaxStop(function(){
                                        $(this).click()
                                        .unbind("ajaxStop");
                                        isCreating = false;
                                    });
                                    //$("#imgTop").unbind("mousemove");
                                    //$("#imgTop").unbind("mousedown");
                                    //$("#imgTop").unbind("mouseup");
                                    $("#imgTop").css("cursor", "default");
                                    $("#imgBottom").css("cursor", "default");
                                }

                        });
                    }
                    else if (thisID === "destroyColumn") {
                      //prep for column adjustment
                      $.each($(".parsingColumn"), function(){
                            $(this).removeClass("parsingColumnSelected");
                        });
                      $(".parsingColumn").bind({
                        mouseenter: function() {
                          $(this).addClass("parsingColumnSelected");
                        },
                        mouseleave: function() {
                          $(this).removeClass("parsingColumnSelected");
                        },
                        click: function() {
                          removeColumn($(this));
                          $(this).hide("blind", 250, function() {
                            //$("#destroyColumnInst").slideUp();
                            //$("#destroyColumn").removeClass("ui-state-active");
                          });
                        }
                      });
                    }
                    else if (thisID === "clearColumns") {
                            //prep for column adjustment
                            var columnSet = $(".parsingColumn");
                            columnSet.addClass("parsingColumnSelected");
                            var columnText = (columnSet.size() === 1) ? "Destroy This Column" : "Destroy "+columnSet.size()+" Columns";
                            $(".destroyPage").html('<span class="left ui-icon ui-icon-circle-close"></span>'+columnText+'')
                            .bind('click', function(){destroyPage();})
                    }
                }
                else if (thisID == "addLines" || thisID == "removeLines" || thisID == "adjustLines" || thisID == "mergeLines") {
                    $("#ctrlLinesInst").find(".startHide").hide();
                    $("#"+show).fadeIn(800);
                    $("#ctrlColumnsInst").find(".activeParsingTool").fadeOut(800);
                    $("#ctrlLinesInst").find(".activeParsingTool").fadeIn(800);
                    $("#imgTop").children(".line").addClass("parsing").removeClass("line");
                    $(".parsing").css("z-index", "5");
                    $('.parsing').unbind();
                    $(".parsing").css('cursor','default');
                    $(".parsingColumn").remove();
                    $(document).unbind("mousedown");
                    $(document).unbind("mousemove");
                    $(document).unbind("mouseup");
                    if (thisID == "adjustLines") {
                        $("#addLines").removeClass("active");
                        $("#removeLines").removeClass("active");
                        //prep for adjustment
                        $("#ruler1").hide();
                        $("#ruler2").hide();
                        var thisLineID = -1;
                        var originalW = 1;
                        var thisLine;
                        $(".parsing").addClass("adjustable").removeClass("line");
                        if($(".adjustable").hasClass("ui-resizable")){
                          $(".adjustable").has(".ui-resizable").resizable("enable");
                        } 
                        else {
                          $(".adjustable").resizable({
                            handles: "e",
                            containment: 'parent',
                            start: function(event, ui) {
                              originalW = ui.originalSize.width;
                              newW = ui.size.width;
                              $("#progress").html("Resizing Line").fadeIn();
                              $("#lineResizing").show();
                              $("#originalLine").html(originalW);
                              $("#newLine").html(Math.round(100 * (newW / originalW)));
                              $("#sidebar").fadeIn();
                              thisLine = $(".ui-resizable-resizing");
                            },
                            resize: function(event, ui) {
                              newW = ui.size.width;
                              $("#newLine").html(Math.round(100 * (newW / originalW)));
                            },
                            stop: function(event, ui) {
                              $("#progress").html("Line Resized - Saving...");
                              var thisLineW = parseFloat(thisLine.attr("linewidth")) * (ui.size.width / originalW);
                              thisLine.attr("linewidth", thisLineW);
                              //console.log("update line with ID: "+thisLineID);
                              updateLine(thisLine);       
                              $("#progress").html("Line Saved").delay(3000).fadeOut(1000);
                              $("#lineResizing").delay(3000).fadeOut(1000);
                            }
                          });
                        }
                    }
                    if (thisID == "addLines"){
                        //writeLines($("#imgTop img"));
                        $("#addLines").addClass("active");
                        $("#removeLines").removeClass("active");
                        $("#mergeLines").removeClass("active");
                        isAddingLines = true;
                        $("#imgTop").children(".line").addClass("parsing").removeClass("line");
                        $(".parsing").bind({
                            mouseenter: function(){
                                applyRuler($(this), false);
                            },
                            mouseleave: function(){
                                removeRuler($(this));
                            },
                            click: function(event){
                                lineChange($(this), event, false);
                            }
                        });

                    }
                    if (thisID == "removeLines" || thisID == "mergeLines"){
                        $("#"+thisID).addClass("active");
                        $("#addLines").removeClass("active");
                        var deleteFlag = false;
                        if(thisID === "removeLines"){
                            deleteFlag=true;
                        }
                        //prep for column adjustment
                        //writeLines($("#imgTop img"));
                        isAddingLines = false;
                        $(".parsing").bind({
                            mouseenter: function(){
                                applyRuler($(this), deleteFlag);
                            },
                            mouseleave: function(){
                                removeRuler($(this));
                            },
                            click: function(event){
                                lineChange($(this), event, deleteFlag);
                            }
                        });
                        $("#imgTop").children(".line").addClass("parsing").removeClass("line");
                    }
                };
            });
           
        
        $(".accordion").children("span")
        .append("<span class='ui-icon ui-icon-triangle-1-e left'></span>")
        .click(function(event){
        //if(!isMember && !permitParsing)return false;
        $("#imgTop").unbind("mousemove");
        $("#imgTop").unbind("mousedown");
        $("#imgTop").unbind("mouseup");
        $("#imgTop").css("cursor", "default");
        $("#imgBottom").css("cursor", "default");
        $(".parsing").unbind('mousemove');
        $("#imgTop").children(".parsing").removeClass("adjustable");
        $(".destroyPage").unbind();
        $(".tpenButton").removeClass("ui-state-active");
        $("#ruler1").hide();
        $("#ruler2").hide();
        var thisID = $(this).attr("id");
        if (!$(this).next("div").is(":visible")) {
            $(this).siblings("div").not($(this).next("div")).slideUp();
            $(this).addClass("ui-state-active")
                .children(".ui-icon-triangle-1-e").switchClass("ui-icon-triangle-1-e","ui-icon-triangle-1-s").end()
                .siblings("span").removeClass("ui-state-active")
                .children(".ui-icon-triangle-1-s").switchClass("ui-icon-triangle-1-s","ui-icon-triangle-1-e");          
            $(this).next("div").slideDown();
        }
        
        
        
        if (thisID === "reparseColumns") {
                //load the adjustment tool and then show the reparsing instructions
                $(".parsingColumn").removeClass("parsingColumnSelected");
                var columnSet = $(".parsingColumn");
                $("#reparseColumn").html('<span class="left ui-icon ui-icon-refresh"></span>Submit '+columnSet.size()+' for Reparsing');
                $("#reparseColumn").bind('click', function(){
                    reparseColumns();
                });
            }
        }); 
        
         $("#brightnessSlider").slider({
            orientation: "horizontal",
            range: "min",
            max: 200,
            min: 0,
            value: 100,
            slide: imageSlider,
            change: imageSlider
        });
        $("#contrastSlider").slider({
            orientation: "horizontal",
            range: "min",
            max: 200,
            min: 0,
            value: 100,
            slide: imageSlider,
            change: imageSlider
        });
        
        $("#previewSplit")
        .on("click",".previewText,.previewNotes",function(){edit(this);})
        .on("click","#previewNotes",function(){
            if($(this).hasClass("ui-state-active")){
                $(".previewNotes").hide();
                $("#previewNotes")
                    .text("Show Notes")
                    .removeClass("ui-state-active");
            } else {
                $(".previewNotes").show();
                $("#previewNotes")
                    .text("Hide Notes")
                    .addClass("ui-state-active");
            }
            scrollToCurrentPage();
        });
    });
    
    /* Allows users to slightly adjust a line within a column while within the transcription interface. */
    function bumpLine(direction, activeLine){
        //values are in pixel, not percentage.
        var id = activeLine.attr("lineserverid");
        if(direction === "left"){
            var currentLineLeft = activeLine.css("left");
            var currentLineLeftPerc = (parseFloat(currentLineLeft) / $("#imgTop").width()) * 100;
            if (currentLineLeftPerc > .3){
                currentLineLeftPerc -= .3;
            }   
            else{ //no negative left value
                currentLineLeftPerc = 0.0;
            }
           currentLineLeft = "%"+currentLineLeftPerc;
        }
        else if (direction === "right"){
            var currentLineLeft = activeLine.css("left");
            var currentLineLeftPerc = (parseFloat(currentLineLeft) / $("#imgTop").width()) * 100;
            //console.log(currentLineLeftPerc);
            if (currentLineLeftPerc < 99.7){ //no left values greater than 100
                currentLineLeftPerc += .3;
            }   
            else{
                currentLineLeftPerc = 100.0;
            }
           currentLineLeft = "%"+currentLineLeftPerc;
        }
        var currentLineLeftPX = parseFloat(currentLineLeftPerc/100) * $("#imgTop").width() + "px";
        $(".transcriptlet[lineserverid='"+id+"']").attr("lineleft", currentLineLeftPerc);
        activeLine.css("left", currentLineLeftPX);
        updateLine($(".transcriptlet[lineserverid='"+id+"']"), "no");
       
    }
    
    //UI effects for when a user decides to edit a line within the preview split tool. 
    function edit(line){
        var focusLineID = $(line).siblings(".previewLineNumber").attr("lineserverid");
        //var focusFolio = $(line).parent(".previewPage").attr("data-pagenumber");
        var transcriptionText = ($(line).hasClass("previewText")) ? ".theText" : ".notes";
        var pair = $(".transcriptlet[lineserverid='"+focusLineID+"']").find(transcriptionText);
        var transcriptlet = $(".transcriptlet[lineserverid='"+focusLineID+"']");
        if ($(line).hasClass("currentPage")){
          if (pair.parent().attr('id') !== focusItem[1].attr('id')){ 
              updatePresentation(transcriptlet);
          }
            line.focus();
            $(line).keyup(function(){
                //Data.makeUnsaved();
                pair.val($(this).text());
            });
        } 
        else {
            //console.log("NOt the current page.")
        }
    }
    
    function scrollToCurrentPage(){
        var pageOffset = $(".previewPage").filter(":first").height() + 20;
        $("#previewDiv").animate({
            scrollTop:pageOffset
        },500);
        $("#previewNotes").filter(".ui-state-active").each( // pulled out #previewAnnotations
            function(){
                if ($("."+this.id).is(":hidden")){
                    $("."+this.id).show();
                    scrollToCurrentPage();
                }
            });
    }
    
    /*
     * Get the inline 'style' attribute of the transcription image containers and attach brightness or contrast filters to it.
     * The entire function is string manipulation and runs quickly.  
     */
    function imageSlider(){
        var newFilter = "";
        if(navigator.userAgent.indexOf("Chrome") !== -1 ) { //also works with filter
          newFilter = "-webkit-filter:";
        } 
        else if(navigator.userAgent.indexOf("Opera") !== -1 ) {
          newFilter = "-o-filter:";
        }
        else if(navigator.userAgent.indexOf("MSIE") !== -1 ) { //also works with filter
          newFilter= "-ms-filter:";
        } 
        else if(navigator.userAgent.indexOf("Firefox") !== -1 ) { //-moz-filter does not work in more recent versions.  The newest version works with regular filter. 
          newFilter = "filter:";
        } 
        else {
            //Uncomment this code to alert the user that their browser does not support these CSS3 Filter tools.
            
//          alert("This tool is not supported by your browser.  The supported browsers are:\n\n\
//                Google Chrome\n Microsoft Internet Explorer\nOpera\nLatest version of Firefox");
//          return false;
        }
        var imgTop = document.getElementById("imgTop");
        var imgBtm = document.getElementById("imgBottom");
        var currentStyleTop = imgTop.getAttribute("style");
        var currentStyleBtm = imgBtm.getAttribute("style"); //null if there is no inline style (this happens)
        if (currentStyleTop === "null" || currentStyleTop === null) currentStyleTop = ""; //in case there is no inline style becase that returns null
        if (currentStyleBtm === "null" || currentStyleBtm === null) currentStyleBtm = ""; //in case there is no inline style because that returns null
        var alteredStyleTop = "";
        var alteredStyleBottom = "";
        var pieceToRemoveTop = "";
        var pieceToRemoveBtm = "";
        //Account for the different ways filter can be represented and alter it accordingly
        if(currentStyleTop.indexOf("-webkit-filter") >= 0){ //Chrome
          //Remove current filter string from the style attribute
          pieceToRemoveTop = currentStyleTop.substring(currentStyleTop.indexOf("-webkit-filter"), currentStyleTop.lastIndexOf(";") + 1);
          pieceToRemoveBtm = currentStyleBtm.substring(currentStyleBtm.indexOf("-webkit-filter"), currentStyleBtm.lastIndexOf(";") + 1);

          //Put the pieces of the filter together
          newFilter += " brightness("+$("#brightnessSlider").slider("value")+"%) contrast("+$("#contrastSlider").slider("value")+"%);";
          alteredStyleTop = currentStyleTop.replace(pieceToRemoveTop, "") + newFilter;
          alteredStyleBottom = currentStyleBtm.replace(pieceToRemoveBtm, "") + newFilter;
        }
        else if(currentStyleTop.indexOf("-ms-filter") >= 0){ //microsoft browsers
          pieceToRemoveTop = currentStyleTop.substring(currentStyleTop.indexOf("-ms-filter"), currentStyleTop.lastIndexOf(";") + 1);
          pieceToRemoveBtm = currentStyleBtm.substring(currentStyleBtm.indexOf("-ms-filter"), currentStyleBtm.lastIndexOf(";") + 1);
          //Put the pieces of the filter together
          newFilter += " brightness("+$("#brightnessSlider").slider("value")+"%) contrast("+$("#contrastSlider").slider("value")+"%);";
          alteredStyleTop = currentStyleTop.replace(pieceToRemoveTop, "") + newFilter;
          alteredStyleBottom = currentStyleBtm.replace(pieceToRemoveBtm, "") + newFilter;
        }
        else if(currentStyleTop.indexOf("-o-filter") >= 0){ //Opera
          //Remove current filter string from the style attribute
          pieceToRemoveTop = currentStyleTop.substring(currentStyleTop.indexOf("-o-filter"), currentStyleTop.lastIndexOf(";") + 1);
          pieceToRemoveBtm = currentStyleBtm.substring(currentStyleBtm.indexOf("-o-filter"), currentStyleBtm.lastIndexOf(";") + 1);
          //Put the pieces of the filter together
          newFilter += " brightness("+$("#brightnessSlider").slider("value")+"%) contrast("+$("#contrastSlider").slider("value")+"%);";
          alteredStyleTop = currentStyleTop.replace(pieceToRemoveTop, "") + newFilter;
          alteredStyleBottom = currentStyleBtm.replace(pieceToRemoveBtm, "") + newFilter;
        }
        else if(currentStyleTop.indexOf("filter") >= 0){ //Works with firefox, IE and Chrome, but we specifically set prefixes at the beginning of the function.
          //Remove current filter string from the style attribute
          pieceToRemoveTop = currentStyleTop.substring(currentStyleTop.indexOf("filter"), currentStyleTop.lastIndexOf(";") + 1);
          pieceToRemoveBtm = currentStyleBtm.substring(currentStyleBtm.indexOf("filter"), currentStyleBtm.lastIndexOf(";") + 1);
          //Put the pieces of the filter together
          newFilter += " brightness("+$("#brightnessSlider").slider("value")+"%) contrast("+$("#contrastSlider").slider("value")+"%);";
          alteredStyleTop = currentStyleTop.replace(pieceToRemoveTop, "") + newFilter;
          alteredStyleBottom = currentStyleBtm.replace(pieceToRemoveBtm, "") + newFilter;
        }
        else{ //First time the filter is being added.  The prefix is already a part of newFilter, so we just need to add the rest of the string.
          newFilter += " brightness("+$("#brightnessSlider").slider("value")+"%) contrast("+$("#contrastSlider").slider("value")+"%);";
          alteredStyleTop = currentStyleTop + " "+newFilter; 
          alteredStyleBottom = currentStyleBtm +" "+newFilter;
        }
        imgTop.setAttribute("style",alteredStyleTop); //set the style attribute with the appropriate filter string attached to it. 
        imgBtm.setAttribute("style",alteredStyleBottom); //set the style attribute with the appropriate filter string attached to it. 
    }
    
    /* Toggle grayscale and invert image CSS filters.v   */
    function toggleFilter(which){
        /*
         * The grayscale/invert toggle classes CANNOT BE DEFINED as the same object being given the brightness/contrast filters or they ALL BREAK
         */
        var filterObjectTop = document.getElementsByClassName("transcriptionImage")[0];
        var filterObjectBottom = document.getElementsByClassName("transcriptionImage")[1];
        var thisFilter = which+"Filter";
        if(filterObjectTop.className.indexOf(thisFilter) >= 0){
          filterObjectTop.className = filterObjectTop.className.replace(thisFilter, '');
          filterObjectBottom.className = filterObjectBottom.className.replace(thisFilter, '');
          $("button[which='"+which+"']").removeClass("selected");
        }
        else{
          filterObjectTop.className = filterObjectTop.className+=" "+thisFilter;
          filterObjectBottom.className = filterObjectBottom.className+=" "+thisFilter;
          $("button[which='"+which+"']").addClass("selected");
        }
    }
    
    //Make sure the value entered into the area that allows a user to define a custom ruler color is a valida color string.  
    function validTextColour(stringToTest) {
        //Alter the following conditions according to your need.
        if (stringToTest === "") { return false; }
        if (stringToTest === "inherit") { return false; }
        if (stringToTest === "transparent") { return true; }

        var image = document.createElement("img");
        image.style.color = "rgb(0, 0, 0)";
        image.style.color = stringToTest;
        if (image.style.color !== "rgb(0, 0, 0)") { return true; }
        image.style.color = "rgb(255, 255, 255)";
        image.style.color = stringToTest;
        return image.style.color !== "rgb(255, 255, 255)";
    }
    
    //Change the ruler color.
    function rulerColor(color){
        if(color==="custom"){
            color=$("#customRuler").val();
            if(validTextColor(color)){
                
            }
            else{
                color = "red";
            }
            
        }
        $("#ruler1").css("color", color).css("background", color);
        $("#ruler2").css("color", color).css("background", color);
        $("#sampleRuler").css("color", color).css("background", color);
    }
    
    //Turn the ruler on
    function applyRuler(line, deleteOnly){
            if(!isAddingLines){
                if(deleteOnly){ //delete line
                    $("#imageTip").html("Remove Last Line");
                    if (line.attr("lineleft") !== line.next("div").attr("lineleft")) {
                        line.addClass('deletable');
                        //only let the deleted line get this cursor when deleting
                        line.css('cursor','pointer');
                    }
                    else{
                        //other lines get the "can't do it" cursor
                        line.css("cursor", "not-allowed");
                    }
                    
                }
                else{ //merge
                    if (line.attr("lineleft") == line.next("div").attr("lineleft")) {
                        line.next("div").addClass('deletable');
                    }
                    line.addClass('deletable');
                    if($(".deletable").size()>1){
                        $(".deletable").addClass("mergeable");
                        $("#imageTip").html("Merge Line");
                    } 
                    else  {
                        $("#imageTip").html("Remove Last Line");
                    }
                    //line.css('cursor','pointer'); //all the lines should get this cursor when merging
                    line.css('cursor','cell'); //all the lines should get this cursor when merging
                }
                $('#ruler1').hide();
            }
            else{ //add lines
                $("#imageTip").html("Add a Line");
                line.css('cursor','crosshair');
                $('#ruler1').show();
            }
            line.bind('mousemove', function(e){
                var imgTopOffset = $("#imgTop").offset().left; //helps because we can center the interface with this and it will still work.
                var myLeft = line.position().left + imgTopOffset;
                var myWidth = line.width();
                $('#imageTip').show().css({
                    left:e.pageX,
                    top:e.pageY+20
                });
                $('#ruler1').css({
                    left: myLeft,
                    top: e.pageY, 
                    height:'1px',
                    width:myWidth 
                });

            });
    }
    
//    //Turn the ruler on
//    function applyRuler(line){
//            //var sRCbkp = selectRulerColor; //select Ruler Color backup
//            $("#imageTip").html("Add a Line");
//            if(!isAddingLines){
//                if (line.attr("lineleft") == line.next("div").attr("lineleft")) {
//                    line.next("div").addClass('deletable');
//                }
//                line.addClass('deletable');
//                if($(".deletable").size()>1){
//                    $(".deletable").addClass("mergeable");
//                    $("#imageTip").html("Merge Line");
//                } else {
//                    $("#imageTip").html("Delete Line");
//                }
//               //sRCbkp = 'transparent';
//            }
//            line.css('cursor','crosshair').bind('mousemove', function(e){
//                var myLeft = line.position().left + $("#imgTop").offset().left;
//                var myWidth = line.width();
//                $('#imageTip').show().css({
//                    left:e.pageX,
//                    top:e.pageY+20
//                });
//                $('#ruler1').show().css({
//                    left: myLeft,
//                    top: e.pageY,
//                    height:'1px',
//                    width:e.pageX-myLeft-7,
//                    //background:"red"
//                });
//                $('#ruler2').show().css({
//                    left: e.pageX+7,
//                    top: e.pageY,
//                    width:myWidth+myLeft-e.pageX-7,
//                    height:'1px',
//                   // background:"red"
//                });
//            });
//        
//    }
    /**
     * Hides ruler within parsing tool. Called on mouseleave .parsing.
     */
    function removeRuler(line){
        if(!isAddingLines){$(".deletable").removeClass('deletable mergeable');}
        //line.unbind('mousemove');
        $('#imageTip').hide();
        $('#ruler1').hide();
        $('#ruler2').hide();
    }
    
    //Triggered when a user alters a line to either create a new one or destroy one.
    function lineChange(e,event,deleteOnly){
        $("#parsingCover").show();
        if(isAddingLines){
            splitLine(e,event);
        }
        else{
            //merge the line you clicked with the line below.  Delete the line below and grow this line by that lines height.
            removeLine(e, false, deleteOnly);
        }

    }
      
    function peekZoom(cancel){
        var topImg = $("#imgTop img");
        var btmImg = $("#imgBottom img");
        var availableRoom = new Array (Page.height()-$(".navigation").height(),$("#transcriptionCanvas").width());
        var line = $(".activeLine:first");
        var limitIndex = (line.width()/line.height()> availableRoom[1]/availableRoom[0]) ? 1 : 0;
        var zoomRatio = (limitIndex === 1) ? availableRoom[1]/line.width() : availableRoom[0]/line.height();
        var imgDims = new Array (topImg.height(),topImg.width(),parseInt(topImg.css("left")),-line.position().top);
        
        if (!cancel){
            //zoom in
            //$("#imgTop img,#imgBottom img,#imgTop .lineColIndicatorArea, #imgBottom .lineColIndicatorArea, #bookmark, #imgTop, #imgBottom").addClass('noTransition');
            if($(".parsing").size()>0){
                // Parsing tool is open
                return false;
            }
            $(".lineColIndicatorArea").fadeOut();
            peekMemory = [parseFloat(topImg.css("top")),parseFloat(btmImg.css("top")),$("#imgTop").css("height")];
            //For some reason, doing $("#imgTop").height() and getting the integer value causes the interface to be broken when restored in the else below, even though it is the same value.
            $("#imgTop").css({
                "height"    : line.height() * zoomRatio + "px"
            });
            topImg.css({
                "width"     : imgDims[1] * zoomRatio + "px",
                "left"      : -line.position().left * zoomRatio,
                "top"       : imgDims[3] * zoomRatio,
                "max-width" : imgDims[1] * zoomRatio / availableRoom[1] * 100 + "%"
            });
            btmImg.css({
                "left"      : -line.position().left * zoomRatio,
                "top"       : (imgDims[3]-line.height()) * zoomRatio,
                "width"     : imgDims[1] * zoomRatio + "px",
                "max-width" : imgDims[1] * zoomRatio / availableRoom[1] * 100 + "%"
            });
            isPeeking = true;
        } 
        else {
            //zoom out
            //$("#imgTop img,#imgBottom img,#imgTop .lineColIndicatorArea, #imgBottom .lineColIndicatorArea, #bookmark, #imgTop, #imgBottom").removeClass('noTransition');
            topImg.css({
                "width"     : "100%",
                "left"      : 0,
                "top"       : peekMemory[0],
                "max-width" : "100%"
            });
            btmImg.css({
                "width"     : "100%",
                "left"      : 0,
                "top"       : peekMemory[1],
                "max-width" : "100%"
            });
            $("#imgTop").css({
                "height"    : peekMemory[2]
            });
            $(".lineColIndicatorArea").fadeIn();
            isPeeking = false;
        }
    };
    
    function toggleMoveImage(event) {
        //if (event && event.altKey && (event.ctrlKey || event.metaKey)) {
        if(!toggleMove){
            $(document).unbind("mousemove");
            $(document).unbind("mouseup");
            $(".lineColIndicatorArea").hide();
            fullTopImage();
            toggleMove = true;
            $("#imgTop img,#imgBottom img,#imgTop .lineColIndicatorArea, #imgBottom .lineColIndicatorArea, #bookmark, #imgTop, #imgBottom").addClass('noTransition');
            //$("#imgTop, #imgBottom").css("cursor", "url(images/open_grab.png),auto");
            //$(dragHelper).appendTo("body");
            startMoveImg();
    //        $("#imgTop, #imgBottom")
    //        .mousedown() //This will handle the mouse up
        }   
        //}
        if(event === false){
            $("#imgTop, #imgBottom").unbind("mousedown");
            $("#imgTop, #imgBottom").unbind("mousemove"); //This is what we needed from the mousup event
            $("#imgTop, #imgBottom").unbind("mouseup"); //This is what we needed from the mousup event
            $(document).unbind("mousedown");
            $(document).unbind("mousemove"); //This is what we needed from the mousup event
            $(document).unbind("mouseup"); //This is what we needed from the mousup event
            isMoving = false; //This is what we needed from the mouseup event.
            toggleMove = false;
            $("#moveImage").removeClass("selected");
            $(".transcriptlet").removeClass("moveImage");
            $(".transcriptlet").children("textarea").removeAttr("disabled");
            $("#imgTop, #imgBottom").css("cursor", "default");
            $("#imgTop img,#imgBottom img,#imgTop .lineColIndicatorArea, #imgBottom .lineColIndicatorArea, #bookmark, #imgTop, #imgBottom").removeClass('noTransition');
            fullPage();
            updatePresentation(focusItem[1]);
            $(".lineColIndicatorArea").show();
            
        }
    };
    
</script>
