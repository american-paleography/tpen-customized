<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
            <title>Project Management</title>
            <link type="text/css" href="css/custom-theme/jQuery.css" rel="Stylesheet" />
            <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.js"></script>
            <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.js"></script> 
            <script type="text/javascript" src="js/newberry.js"></script>
    <!--        <link rel="stylesheet" href="http://165.134.241.141/newberry/css/tpen.css" type="text/css" media="screen, projection">--> 
            <style type="text/css" >
                #editProjectMembers{
                    position: relative;
                }
            </style>
    </head>
    <div>
        <div class="closeBtn" onclick="$('#projectUserManagement').hide();">X</div>
        <h4>Add a new group member</h4>
        <p>If the E-mail you enter is not a T-PEN user, a profile will be created for them and they will be placed into the group.  
            Their password is blank, they will need to change it when they log in.
        </p>

        <div id="addUserToGroup">
           <label for="adduname">Username (e-mail) </label><input id="adduname" type="text"/>
           <label for="addfname">First Name </label><input id="addfname" type="text"/>
           <label for="addlname">Last Name </label><input id="addlname" type="text"/>
           <input type="button" value="Add User" onclick="addUserToProject();"/>
        </div>

<!--        <h4>Create a new Group</h4>
        <div id="createNewGroup">
            <input type="text" name="groupName" value="Group Name"/>
            <input type="button" value="Create Group"/>
         </div>-->

        <h4>Existing Members</h4>
        <ul id="editProjectMembers" class="isMember">

        </ul>
    </div>
</html>

<script type="text/javascript">
    
    function addUserToProject(){
        var uname = $("#adduname").val();
        var fname = $("#addfname").val();
        var lname = $("#addlname").val();
        var url= "addUserToProject"; 
        if(uname === "" || fname === "" || lname===""){
            alert("You must provide an E-mail, first name and last name to add a user to the group.");
            return false;
        }
        var params = {"projectID":currentProjectID, "uname":uname, "fname":fname, "lname":lname};
        $.post(url,params,function(data){
            //console.log("add user done.  return the user id to use for pagination function");
            //console.log(data);
            $('#projectMembers').append("<li userID='TODO'><span class='userFname'>"+fname+" </span><span class='userLname'>"+lname+" </span><span style='margin-left:5px;' class='userEmail'>("+uname+")</span></li>"); 
            //reference groups.html to find this html element.
            //TODO
            //need UID from new user created. onclick='promoteUserToAdmin(UID);'
            $('#editProjectMembers').append("<li><a class='promoteUser' title='Promote this user to Group Leader' onclick='promoteUserToAdmin("+data+")' > + </a>\n\
             <span>" + uname + "</span>&nbsp;&nbsp;<a class='removeUser' onclick=\"removeUserFromProject('"+uname+"',$(this).parent());\">Remove member</a></li>");
        });
//        if(jqXHR.status && jqXHR.status==401){
//                     alert("You must be logged in and be the admin of this project"); 
//                }
//                else if (jqXHR.status && jqXHR.status==406){
//                    alert("The user you are attempting to add does not exist or the projectID is incorrect.");
//                }
        
    }
             
    function promoteUserToAdmin(uid){
        var url="changeUserPermission";
        var params = {"projectID":currentProjectID, "act":"changerole", "role":"leader", "uid":uid};
        $.post(url, params);
//        if(jqXHR.status && jqXHR.status==403){
//                     alert("You must specify a project ID."); 
//                }
//                else if (jqXHR.status && jqXHR.status==406){
//                    alert("This is not an existing role or permission");
//                }
//                else if (jqXHR.status && jqXHR.status==0){
//                    alert("This user is not a memeber of the group.");
//                }
//                else if (jqXHR.status && jqXHR.status==1){
//                    alert("Success");
//                }
//                else if (jqXHR.status && jqXHR.status==11){
//                    alert("User is already in the group.");
//                }
        
    }
            
    function removeUserFromProject(username, $elem){
        var url= "delUserFromProject";
        var params = {"uname":username, "projectID":currentProjectID};
        $.post(url, params, function(){
            //console.log("make sure to remove ");
            //console.log($elem);
            $elem.remove();
        });
//        if(jqXHR.status && jqXHR.status==401){
//                     alert("You must be logged in and be the admin of this project"); 
//                }
//                else if (jqXHR.status && jqXHR.status==406){
//                    alert("The user you are attempting to add does not exist or the projectID is incorrect.");
//                }
        
    }

    function createNewGroup(){
        //NEED API FOR THIS
        var url="";
    }
    
    $(function() {

       $('.delete').hover(function()
       {
          $(this).parent().addClass("strikeout");
       },
               function() {
                  $(this).parent().removeClass("strikeout");
               }
       );

       $('.promoteUser').click(function() {
          if(userIsProjectAdmin){
              var name = $(this).parent('li').text();
               var nIn = name.indexOf('Remove');
               if (nIn > 3)
                  name = name.substring(0, nIn - 1);
               var cfrm = confirm('This action will grant ' + name +
                       ' complete access as a Group Leader and cannot be undone.\n\nAre you sure?');
               return cfrm;
          }
          else{
               var errorMsg = confirm("You must have the proper permissions to complete this action. ")
               return errorMsg;
          }

       });
    });
      </script>